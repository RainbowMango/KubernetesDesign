æœ¬èŠ‚ï¼Œæˆ‘ä»¬é€šè¿‡å‡ ä¸ªç®€å•çš„ä¾‹å­æ¥å¿«é€Ÿä½“éªŒ`DaemonSet`æ§åˆ¶å™¨ã€‚

## ç¯å¢ƒå‡†å¤‡
æˆ‘ä»¬ä½¿ç”¨`Kind`å·¥å…·æ¥åˆ›å»ºä¸€ä¸ªåŒ…å«ä¸‰ä¸ªèŠ‚ç‚¹çš„é›†ç¾¤ï¼Œä½¿ç”¨çš„é…ç½®å¦‚ä¸‹æ‰€ç¤ºï¼š
```
[root@ecs-d8b6 book]# cat config_kind.yaml 
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
- role: control-plane
- role: worker
- role: worker
- role: worker
```
ç„¶åï¼Œåˆ›å»ºä¸€ ä¸ªv1.18.0ç‰ˆæœ¬çš„Kubernetesé›†ç¾¤ï¼š
```
[root@ecs-d8b6 book]# kind create cluster --config config_kind.yaml --image=kindest/node:v1.18.0
Creating cluster "kind" ...
 âœ“ Ensuring node image (kindest/node:v1.18.0) ğŸ–¼ 
 âœ“ Preparing nodes ğŸ“¦ ğŸ“¦ ğŸ“¦ ğŸ“¦  
 âœ“ Writing configuration ğŸ“œ 
 âœ“ Starting control-plane ğŸ•¹ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ 
 âœ“ Installing CNI ğŸ”Œ 
 âœ“ Installing StorageClass ğŸ’¾ 
 âœ“ Joining worker nodes ğŸšœ 
Set kubectl context to "kind-kind"
You can now use your cluster with:

kubectl cluster-info --context kind-kind
```

é›†ç¾¤åˆ›å»ºå®Œæˆåï¼Œæ£€æŸ¥å„èŠ‚ç‚¹æ˜¯å¦å·²æ­£å¸¸å·¥ä½œï¼š
```
[root@ecs-d8b6 book]# kubectl get nodes
NAME                 STATUS   ROLES    AGE     VERSION
kind-control-plane   Ready    master   3m6s    v1.18.0
kind-worker          Ready    <none>   2m30s   v1.18.0
kind-worker2         Ready    <none>   2m31s   v1.18.0
kind-worker3         Ready    <none>   2m30s   v1.18.0
```
å¯ä»¥çœ‹åˆ°æ‰€æœ‰èŠ‚ç‚¹éƒ½å·²å¤„äº`Ready`çŠ¶æ€ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±åˆ›å»ºä¸€ä¸ª`DaemonSet`å¯¹è±¡ï¼Œå®ƒå¯ä»¥ä¿è¯åœ¨æ¯ä¸ªå·¥ä½œèŠ‚ç‚¹ä¸Šåˆ›å»ºä¸€ä¸ª`Pod`å‰¯æœ¬ã€‚

## åˆ›å»º
é¦–å…ˆæˆ‘ä»¬å…ˆå°†ä»¥ä¸‹é…ç½®ä¿å­˜åˆ°åä¸º`daemonset.yaml`çš„æ–‡ä»¶ä¸­ã€‚
```
[root@ecs-d8b6 manifests]# cat daemonset.yaml 
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: nginx-daemonset
  labels:
    app: nginx
spec:
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
        - name: nginx
          image: nginx:1.19.0
```
è¯¥ä»½é…ç½®å°†åˆ›å»ºä¸€ä¸ª`DaemonSet`å¯¹è±¡ï¼Œç„¶å`DaemonSet`æ§åˆ¶å™¨ä¼šæ ¹æ®è¯¥å¯¹è±¡ä¿¡æ¯åˆ†åˆ«åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šåˆ›å»ºä¸€ä¸ªPodå‰¯æœ¬ã€‚

æ¥ä¸‹æ¥ä½¿ç”¨`kubectl create`å‘½ä»¤å°†è¯¥é…ç½®ææ¬¡ç»™`kube-apiserver`ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
```
[root@ecs-d8b6 manifests]# kubectl create -f daemonset.yaml 
daemonset.apps/nginx-daemonset created
```

## æŸ¥çœ‹
é¦–å…ˆæŸ¥çœ‹åˆšåˆšåˆ›å»ºçš„`DaemonSet`å¯¹è±¡ï¼š
```
[root@ecs-d8b6 manifests]# kubectl get daemonset 
NAME              DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE
nginx-daemonset   3         3         3       3            3           <none>          5m6s
```
å‘½ä»¤è¡Œè¾“å‡ºä¸­å„å­—æ®µå«ä¹‰å¦‚ä¸‹ï¼š
- NAME: `DaemonSet`å¯¹è±¡åç§°ï¼ŒåŒé…ç½®ä¸­çš„`metadata.name`ï¼›
- DESIREDï¼šéœ€æ±‚å‰¯æœ¬ä¸ªæ•°ï¼Œç”±äºæ²¡æœ‰åˆ»æ„ç­›é€‰èŠ‚ç‚¹ï¼Œæ‰€ä»¥å‰¯æœ¬ä¸ªæ•°ç­‰åŒäºèŠ‚ç‚¹ä¸ªæ•°ï¼›
- CURRENTï¼šå½“å‰å·²åˆ›å»ºçš„å‰¯æœ¬ä¸ªæ•°ï¼›
- READYï¼šå¤„äº`Ready`çŠ¶æ€çš„å‰¯æœ¬ä¸ªæ•°ï¼›
- UP-TO-DATEï¼šå·²æŒ‰æœ€æ–°`Pod`æ¨¡ç‰ˆåˆ›å»ºçš„Podä¸ªæ•°ï¼›
- AVAILABLEï¼šå¯ç”¨çš„å‰¯æœ¬ä¸ªæ•°ï¼›
- NODE SELECTORï¼šèŠ‚ç‚¹é€‰æ‹©å™¨ï¼Œæœ¬ä¾‹ä¸­æˆ‘ä»¬æ²¡æœ‰é€‰æ‹©ï¼Œå€¼ä¸ºç©ºï¼›
- AGEï¼šåˆ›å»ºè‡³ä»Šç»å†çš„æ—¶é—´ã€‚

ä¸Šé¢çš„å­—æ®µä¸­ï¼Œé™¤äº†`NODE SELECTOR`ä»¥å¤–ï¼Œæˆ‘ä»¬å·²åœ¨å‰é¢çš„ç« èŠ‚ä¸­ä»‹ç»è¿‡ã€‚å…¶å®`Node Selector`å¹¶ä¸æ˜¯`DaemonSet`å¯¹è±¡ç‰¹æœ‰çš„é…ç½®ï¼Œå®ƒæ˜¯`Pod`æ¨¡ç‰ˆä¸­ç”¨äºä¸ºPodåŒ¹é…èŠ‚ç‚¹çš„é…ç½®ï¼Œ`DaemonSet`æ§åˆ¶å™¨ä½¿ç”¨è¯¥`Node Selector`æ¥ç­›é€‰éœ€è¦åˆ›å»ºå‰¯æœ¬çš„èŠ‚ç‚¹ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šï¼Œåˆ™é»˜è®¤é€‰æ‹©å…¨éƒ¨èŠ‚ç‚¹ã€‚

æ¥ç€ï¼ŒæŸ¥çœ‹`DaemonSet`æ§åˆ¶å™¨æ‰€åˆ›å»ºçš„Podå‰¯æœ¬ä¿¡æ¯ï¼š
```
[root@ecs-d8b6 manifests]# kubectl get pods -o wide
NAME                    READY   STATUS    RESTARTS   AGE     IP           NODE           NOMINATED NODE   READINESS GATES
nginx-daemonset-78dbc   1/1     Running   0          5m13s   10.244.3.2   kind-worker3   <none>           <none>
nginx-daemonset-gmpdg   1/1     Running   0          5m13s   10.244.1.2   kind-worker2   <none>           <none>
nginx-daemonset-l6wn4   1/1     Running   0          5m13s   10.244.2.2   kind-worker    <none>           <none>
```
å¯ä»¥çœ‹åˆ°ï¼Œæ¯ä¸ªèŠ‚ç‚¹ä¸Šå‡åˆ›å»ºäº†ä¸€ä¸ªå‰¯æœ¬ï¼Œç¬¦åˆé¢„æœŸã€‚

## æ›´æ–°
æ¥ä¸‹æ¥æˆ‘ä»¬è¯•å›¾è°ƒæ•´Podéƒ¨ç½²ç­–ç•¥ï¼Œæˆ‘ä»¬åªå¸Œæœ›Podè¿è¡Œåœ¨åä¸º`kind-worker`çš„èŠ‚ç‚¹ä¸Šï¼Œè¿™æ ·æˆ‘ä»¬åªéœ€è¦é…ç½®`DaemonSet`å¯¹è±¡çš„`spec.template.spec.nodeSelector`æ¥é€‰æ‹©èŠ‚ç‚¹å³å¯ã€‚

åœ¨`kind-worker`çš„èŠ‚ç‚¹ä¸­å­˜åœ¨ä¸€ä¸ªæ ‡è¯†èŠ‚ç‚¹çš„labelï¼š
```
kubernetes.io/hostname: kind-worker
```
æ‰€ä»¥`DaemonSet`å¯¹è±¡çš„`spec.template.spec.nodeSelector`é…ç½®å¦‚ä¸‹ï¼š
```
apiVersion: apps/v1
kind: DaemonSet
metadata:
  ...
spec:
  ...
  template:
    ...
    spec:
      ...
      nodeSelector:
        kubernetes.io/hostname: kind-worker
```
ä½¿ç”¨`kubectl edit`å‘½ä»¤ä¿®æ”¹é…ç½®ï¼Œç„¶åå†æ¬¡è§‚å¯Ÿ`DaemonSet`å¯¹è±¡å’ŒPodå‰¯æœ¬ï¼š
```
[root@ecs-d8b6 manifests]# kubectl get daemonsets
NAME              DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR                        AGE
nginx-daemonset   1         1         1       1            1           kubernetes.io/hostname=kind-worker   37m
[root@ecs-d8b6 manifests]# kubectl get pods -o wide
NAME                    READY   STATUS    RESTARTS   AGE   IP           NODE          NOMINATED NODE   READINESS GATES
nginx-daemonset-66gk2   1/1     Running   0          10s   10.244.2.3   kind-worker   <none>           <none>
```
å¯ä»¥å‘ç°`DaemonSet`çŠ¶æ€ä¸­ï¼Œ`NODE SELECTOR`æ­£ç¡®åœ°ä½“ç°äº†æˆ‘ä»¬çš„ä¿®æ”¹ï¼Œè€Œä¸”éœ€æ±‚çš„Podå‰¯æœ¬æ•°ä¹Ÿå˜æˆäº†1ä¸ªï¼Œç¬¦åˆé¢„æœŸã€‚
åŸæ¥è¿è¡Œçš„3ä¸ªPodå‰¯æœ¬å‡å°‘åˆ°1ä¸ªï¼Œè€Œä¸”åªåœ¨æˆ‘ä»¬é€‰å®šçš„èŠ‚ç‚¹ä¸Šè¿è¡Œã€‚

## åˆ é™¤
åƒå…¶ä»–Podæ§åˆ¶å™¨ä¸€æ ·ï¼Œå½“åˆ é™¤`DaemonSet`å¯¹è±¡æ—¶ï¼Œå…¶æ‰€ç®¡ç†çš„Podé»˜è®¤ä¹Ÿä¼šè¢«åˆ é™¤ï¼Œæ“ä½œå¦‚ä¸‹æ‰€ç¤ºï¼š
```
[root@ecs-d8b6 ~]# kubectl delete daemonsets nginx-daemonset 
daemonset.apps "nginx-daemonset" deleted
[root@ecs-d8b6 ~]# kubectl get pods 
No resources found in default namespace.
```